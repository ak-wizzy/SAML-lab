<!doctype html>
<html>
<head>
  <title>SAML Claims</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 2rem;
      line-height: 1.5;
    }
    h1, h2 {
      margin-top: 1.5rem;
    }
    ul {
      margin-left: 1.5rem;
    }
    .section {
      margin-bottom: 2rem;
    }
    .muted {
      color: #666;
      font-size: 0.9em;
    }
    details {
      margin-top: 0.5rem;
    }
    code {
      background: #f4f4f4;
      padding: 0.2em 0.4em;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <h1>SAML Claims</h1>

  <!-- Session Overview -->
  <div class="section">
    <h2>Session Overview</h2>
    <ul>
      <li><strong>NameID:</strong> {{ nameid }}</li>
      {% if session_index %}
        <li><strong>Session Index:</strong> {{ session_index }}</li>
      {% endif %}
      {% if session.get("login_time") %}
        <li><strong>Login time (UTC):</strong> {{ session.get("login_time") }}</li>
      {% endif %}
      <li><strong>Roles:</strong> {{ roles | join(", ") if roles else "None" }}</li>
      <li><strong>Groups received:</strong> {{ groups | length }}</li>
    </ul>
  </div>

  <!-- Derived Roles -->
  <div class="section">
    <h2>Derived Roles</h2>
    {% if roles %}
      <ul>
        {% for role in roles %}
          <li>{{ role }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No roles derived for this user.</p>
    {% endif %}
  </div>

  <!-- Group Information -->
  <div class="section">
    <h2>Group Information</h2>
    <p>Groups received from Entra ID: <strong>{{ groups | length }}</strong></p>

    {% if debug and groups %}
      <details>
        <summary>Show raw group Object IDs (debug)</summary>
        <ul>
          {% for group in groups %}
            <li>{{ group }}</li>
          {% endfor %}
        </ul>
      </details>
    {% endif %}
  </div>

  <!-- Certificate Awareness (read-only for now) -->
  {% if debug %}
    <div class="section">
      <h2>Certificate Validation</h2>
      {% if session.get("idp_cert_fingerprint") %}
        <p class="muted">
          Assertion validated using IdP certificate fingerprint:
          <code>{{ session.get("idp_cert_fingerprint") }}</code>
        </p>
      {% else %}
        <p class="muted">
          Certificate fingerprint not available (cert rotation awareness not enabled yet).
        </p>
      {% endif %}
    </div>
  {% endif %}

  <!-- Raw Claims -->
  <div class="section">
    <h2>Raw SAML Claims</h2>
    <ul>
      {% for key, values in attributes.items() %}
        <li>
          <strong>{{ key }}</strong>: {{ values }}
        </li>
      {% endfor %}
    </ul>
  </div>

  <hr>

  <p>
    <a href="/">Home</a>
    {% if debug %}
      | <span class="muted">Debug mode enabled</span>
    {% endif %}
  </p>

  <p>
    <a href="/logout">Local logout</a> |
    <a href="/slo">Federated logout (SLO)</a>
  </p>

</body>
</html>
